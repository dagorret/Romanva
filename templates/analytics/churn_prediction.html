{% extends 'base.html' %}

{% block title %}Predicci√≥n de Abandono Estudiantil - Romanova{% endblock %}

{% block content %}
<div class="container">
    <h2>üéØ Predicci√≥n de Abandono Estudiantil (Churn Prediction)</h2>
    <p class="subtitle">Machine Learning con Random Forest para identificar estudiantes en riesgo</p>

    <!-- Resumen Ejecutivo -->
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: white;">üìä Resumen Ejecutivo</h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px;">
            <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: bold;">{{ total_students }}</div>
                <div style="font-size: 14px; opacity: 0.9;">Total Estudiantes</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: bold; color: #10b981;">{{ active_students }}</div>
                <div style="font-size: 14px; opacity: 0.9;">Activos</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: bold; color: #ef4444;">{{ churned_students }}</div>
                <div style="font-size: 14px; opacity: 0.9;">Inactivos</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: bold;">{{ churn_rate }}%</div>
                <div style="font-size: 14px; opacity: 0.9;">Tasa de Abandono</div>
            </div>
        </div>
    </div>

    {% if feature_importance %}
    <!-- Importancia de Variables -->
    <div class="card" style="margin-bottom: 30px;">
        <h3>üîç Factores m√°s Importantes para Predecir Abandono</h3>
        <p style="color: #6b7280; margin-bottom: 20px;">
            El modelo Random Forest identific√≥ qu√© variables tienen mayor impacto en la predicci√≥n.
        </p>
        <table>
            <thead>
                <tr>
                    <th>Variable</th>
                    <th>Importancia (%)</th>
                    <th>Visualizaci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for feature in feature_importance %}
                <tr>
                    <td><strong>{{ feature.feature }}</strong></td>
                    <td>{{ feature.importance }}%</td>
                    <td>
                        <div style="width: {{ feature.importance }}%; height: 24px; background: linear-gradient(90deg, #8b5cf6, #ec4899); border-radius: 4px;"></div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Estudiantes en Riesgo -->
    {% if predictions %}
    <div class="card">
        <h3>‚ö†Ô∏è Estudiantes en Alto Riesgo de Abandono</h3>
        <p style="color: #6b7280; margin-bottom: 10px;">
            Top {{ high_risk_count }} estudiantes con mayor probabilidad de abandonar (>70%).
            <strong>Acci√≥n recomendada:</strong> Contactar proactivamente y ofrecer soporte acad√©mico.
        </p>

        <table>
            <thead>
                <tr>
                    <th>Estudiante</th>
                    <th>Probabilidad Abandono</th>
                    <th>Nivel de Riesgo</th>
                    <th>D√≠as Sin Acceso</th>
                    <th>Total Accesos</th>
                    <th>Estado Actual</th>
                </tr>
            </thead>
            <tbody>
                {% for pred in predictions %}
                <tr>
                    <td>{{ pred.user.fullname }}</td>
                    <td>
                        <strong style="color: {% if pred.churn_probability > 70 %}#dc3545{% elif pred.churn_probability > 40 %}#ffc107{% else %}#28a745{% endif %}">
                            {{ pred.churn_probability }}%
                        </strong>
                    </td>
                    <td>
                        <span style="padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600;
                            {% if pred.risk_level == 'Alto' %}background: #fee; color: #dc3545;{% elif pred.risk_level == 'Medio' %}background: #fef3c7; color: #d97706;{% else %}background: #d1fae5; color: #065f46;{% endif %}">
                            {{ pred.risk_level }}
                        </span>
                    </td>
                    <td>{{ pred.days_since_access }}</td>
                    <td>{{ pred.total_accesses }}</td>
                    <td>
                        <span style="font-size: 13px; {% if pred.actual_status == 'Inactivo' %}color: #dc3545;{% else %}color: #10b981;{% endif %}">
                            {{ pred.actual_status }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert">
        <p>No hay suficientes datos para entrenar el modelo predictivo (m√≠nimo 10 estudiantes con historial).</p>
    </div>
    {% endif %}

    <!-- Metodolog√≠a -->
    <div class="card" style="margin-top: 30px; background: #f9fafb;">
        <h3>üìö Metodolog√≠a</h3>
        <ul style="color: #6b7280; line-height: 1.8;">
            <li><strong>Algoritmo:</strong> Random Forest Classifier (50 √°rboles, profundidad m√°x: 5)</li>
            <li><strong>Definici√≥n de "Abandono":</strong> Sin acceso en los √∫ltimos 30 d√≠as</li>
            <li><strong>Variables de entrada:</strong> Accesos totales, cursos inscriptos, grupos, d√≠as sin acceso, accesos semanales</li>
            <li><strong>Per√≠odo de an√°lisis:</strong> √öltimos 90 d√≠as de actividad</li>
            <li><strong>Normalizaci√≥n:</strong> StandardScaler para equilibrar escalas</li>
        </ul>
        <p style="margin-top: 20px; padding: 15px; background: white; border-left: 4px solid #7c3aed; color: #374151;">
            <strong>üí° Insight gerencial:</strong> Los "D√≠as Sin Acceso" y "Accesos Semanales" suelen ser los mejores predictores.
            Estudiantes que pasan m√°s de 15 d√≠as sin acceder tienen 70%+ probabilidad de abandono.
        </p>
    </div>

    <div style="margin-top: 30px;">
        <a href="{% url 'analytics_menu' %}" class="button">‚Üê Volver al men√∫ de estad√≠sticas</a>
    </div>
</div>
{% endblock %}
