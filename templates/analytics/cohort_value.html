{% extends 'base.html' %}

{% block title %}An√°lisis de Valor de Cohorte - Romanova{% endblock %}

{% block content %}
<div class="container">
    <h2>üí∞ An√°lisis de Valor de Cohorte (Cohort Value Analysis)</h2>
    <p class="subtitle">ROI y retenci√≥n por generaci√≥n de estudiantes (an√°lisis trimestral)</p>

    <!-- Resumen Ejecutivo -->
    <div class="card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: #111827; margin-bottom: 30px;">
        <h3 style="margin-top: 0;">üìä Indicadores Clave</h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-top: 20px;">
            <div>
                <div style="font-size: 16px; margin-bottom: 10px; opacity: 0.8;">Mejor Cohorte</div>
                {% if best_cohort %}
                <div style="background: white; padding: 15px; border-radius: 10px;">
                    <div style="font-size: 28px; font-weight: bold; color: #10b981;">{{ best_cohort.cohort }}</div>
                    <div style="color: #6b7280; margin-top: 5px;">Valor: {{ best_cohort.cohort_value }} | Retenci√≥n: {{ best_cohort.retention_rate }}%</div>
                </div>
                {% else %}
                <div style="background: white; padding: 15px; border-radius: 10px; color: #6b7280;">Sin datos</div>
                {% endif %}
            </div>
            <div>
                <div style="font-size: 16px; margin-bottom: 10px; opacity: 0.8;">Peor Cohorte</div>
                {% if worst_cohort %}
                <div style="background: white; padding: 15px; border-radius: 10px;">
                    <div style="font-size: 28px; font-weight: bold; color: #ef4444;">{{ worst_cohort.cohort }}</div>
                    <div style="color: #6b7280; margin-top: 5px;">Valor: {{ worst_cohort.cohort_value }} | Retenci√≥n: {{ worst_cohort.retention_rate }}%</div>
                </div>
                {% else %}
                <div style="background: white; padding: 15px; border-radius: 10px; color: #6b7280;">Sin datos</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tabla de Cohortes -->
    {% if cohorts %}
    <div class="card">
        <h3>üìà Evoluci√≥n de Cohortes (√öltimos 8 Trimestres)</h3>
        <p style="color: #6b7280; margin-bottom: 20px;">
            Cada fila representa un trimestre de inscripci√≥n. El "Valor de Cohorte" combina engagement, retenci√≥n y cursos promedio.
        </p>

        <table>
            <thead>
                <tr>
                    <th>Cohorte</th>
                    <th>Estudiantes</th>
                    <th>Activos</th>
                    <th>Retenci√≥n (%)</th>
                    <th>Total Accesos</th>
                    <th>Accesos Promedio</th>
                    <th>Cursos Promedio</th>
                    <th>Valor Cohorte</th>
                    <th>Rating</th>
                </tr>
            </thead>
            <tbody>
                {% for cohort in cohorts %}
                <tr>
                    <td><strong>{{ cohort.cohort }}</strong></td>
                    <td>{{ cohort.students_count }}</td>
                    <td>{{ cohort.active_count }}</td>
                    <td>
                        <span style="font-weight: 600; color: {% if cohort.retention_rate > 70 %}#10b981{% elif cohort.retention_rate > 40 %}#f59e0b{% else %}#ef4444{% endif %}">
                            {{ cohort.retention_rate }}%
                        </span>
                    </td>
                    <td>{{ cohort.total_accesses }}</td>
                    <td>{{ cohort.avg_accesses }}</td>
                    <td>{{ cohort.avg_courses }}</td>
                    <td>
                        <strong style="font-size: 16px; color: #7c3aed;">{{ cohort.cohort_value }}</strong>
                    </td>
                    <td>{{ cohort.value_rating }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert">
        <p>No hay datos de cohortes disponibles.</p>
    </div>
    {% endif %}

    <!-- Insights y F√≥rmula -->
    <div class="card" style="margin-top: 30px; background: #f0f9ff;">
        <h3 style="color: #0369a1;">üí° Interpretaci√≥n del Valor de Cohorte</h3>
        <div style="color: #075985; line-height: 1.8;">
            <p><strong>F√≥rmula del Valor de Cohorte:</strong></p>
            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0; font-family: monospace; border-left: 4px solid #0ea5e9;">
                Valor = (Accesos Promedio √ó 0.4) + (Cursos Promedio √ó 10) + (Retenci√≥n % √ó 0.5)
            </div>

            <p><strong>¬øQu√© nos dice este an√°lisis?</strong></p>
            <ul style="margin-left: 20px;">
                <li><strong>Cohortes de alto valor (>100):</strong> Estudiantes altamente comprometidos, m√∫ltiples cursos, alta retenci√≥n</li>
                <li><strong>Cohortes de valor medio (50-100):</strong> Desempe√±o aceptable, oportunidad de mejora</li>
                <li><strong>Cohortes de bajo valor (<50):</strong> Requieren intervenci√≥n urgente, alto riesgo de abandono masivo</li>
            </ul>

            <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <strong>üéØ Decisiones Estrat√©gicas:</strong>
                <ul style="margin-top: 10px;">
                    <li>Asignar m√°s recursos a cohortes de alto valor (est√°n funcionando bien)</li>
                    <li>Investigar qu√© cambi√≥ en cohortes de bajo valor (¬øcambio de docentes? ¬øcontenido?)</li>
                    <li>Comparar cohortes Q1 vs Q2 del mismo a√±o para detectar estacionalidad</li>
                    <li>Usar cohortes exitosas como benchmark para las nuevas</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Gr√°fico de Tendencia (simulado con texto) -->
    <div class="card" style="margin-top: 30px; background: #faf5ff;">
        <h3 style="color: #7c3aed;">üìâ Tendencia General</h3>
        {% if cohorts %}
        <p style="color: #6b7280;">
            {% with first=cohorts|last last=cohorts|first %}
            {% if first and last %}
                De {{ first.cohort }} a {{ last.cohort }},
                {% if last.cohort_value > first.cohort_value %}
                    <strong style="color: #10b981;">‚Üó Tendencia positiva</strong>: El valor de cohorte mejor√≥ de {{ first.cohort_value }} a {{ last.cohort_value }}
                    (+{{ last.cohort_value|add:"-"|add:first.cohort_value|floatformat:0 }} puntos)
                {% else %}
                    <strong style="color: #ef4444;">‚Üò Tendencia negativa</strong>: El valor de cohorte cay√≥ de {{ first.cohort_value }} a {{ last.cohort_value }}
                {% endif %}
            {% endif %}
            {% endwith %}
        </p>
        {% endif %}
    </div>

    <div style="margin-top: 30px;">
        <a href="{% url 'analytics_menu' %}" class="button">‚Üê Volver al men√∫ de estad√≠sticas</a>
    </div>
</div>
{% endblock %}
