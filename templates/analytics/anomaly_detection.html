{% extends 'base.html' %}

{% block title %}Detecci√≥n de Anomal√≠as - Romanova{% endblock %}

{% block content %}
<div class="container">
    <h2>üîç Detecci√≥n de Anomal√≠as con Isolation Forest</h2>
    <p class="subtitle">Identificaci√≥n autom√°tica de patrones inusuales y comportamientos at√≠picos en cursos</p>

    <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: white;">üìä Resumen del An√°lisis</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
            <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: bold;">{{ total_courses_analyzed }}</div>
                <div style="font-size: 14px; opacity: 0.9;">Cursos Analizados</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: bold; color: #fef3c7;">{{ anomalies_detected }}</div>
                <div style="font-size: 14px; opacity: 0.9;">Anomal√≠as Detectadas</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 36px; font-weight: bold;">{{ contamination_rate }}%</div>
                <div style="font-size: 14px; opacity: 0.9;">Tasa de Contaminaci√≥n</div>
            </div>
        </div>
    </div>

    {% if anomalies %}
    <div class="card">
        <h3>‚ö†Ô∏è Cursos con Comportamiento An√≥malo</h3>
        <p style="color: #6b7280; margin-bottom: 20px;">
            Isolation Forest ha identificado {{ anomalies|length }} cursos con patrones estad√≠sticamente inusuales.
            Score m√°s alto = anomal√≠a m√°s extrema.
        </p>

        <table>
            <thead>
                <tr>
                    <th>Curso</th>
                    <th>Tipo de Anomal√≠a</th>
                    <th>Score</th>
                    <th>Inscritos</th>
                    <th>Engagement (%)</th>
                    <th>Accesos/Est.</th>
                    <th>Ratio Actividad</th>
                </tr>
            </thead>
            <tbody>
                {% for anomaly in anomalies %}
                <tr style="{% if forloop.counter0 < 3 %}background: #fef2f2;{% endif %}">
                    <td><strong>{{ anomaly.course.shortname }}</strong></td>
                    <td>
                        <span style="font-size: 13px; padding: 4px 8px; background: #fee; color: #dc3545; border-radius: 6px;">
                            {{ anomaly.anomaly_types }}
                        </span>
                    </td>
                    <td>
                        <strong style="font-size: 16px; color: #dc3545;">{{ anomaly.anomaly_score }}</strong>
                    </td>
                    <td>{{ anomaly.total_enrolled }}</td>
                    <td>
                        <span style="font-weight: 600; color: {% if anomaly.engagement_rate < 20 %}#ef4444{% elif anomaly.engagement_rate < 50 %}#f59e0b{% else %}#10b981{% endif %}">
                            {{ anomaly.engagement_rate }}%
                        </span>
                    </td>
                    <td>{{ anomaly.accesses_per_student }}</td>
                    <td>{{ anomaly.activity_ratio }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card" style="margin-top: 30px; background: #f0f9ff;">
        <h3 style="color: #0369a1;">üîç Tipos de Anomal√≠as Detectadas</h3>
        <div style="color: #075985; line-height: 1.8;">
            <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ef4444;">
                <strong>üìâ Engagement Cr√≠tico:</strong> Menos del 20% de estudiantes inscritos han accedido recientemente.
                <br><strong>Acci√≥n:</strong> Revisar contenido, verificar notificaciones, contactar profesor urgentemente.
            </div>

            <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #f59e0b;">
                <strong>üìà Actividad Excesiva:</strong> M√°s de 100 accesos promedio por estudiante (puede indicar problemas t√©cnicos o bots).
                <br><strong>Acci√≥n:</strong> Revisar logs de acceso, verificar si hay actividad automatizada, validar m√©tricas.
            </div>

            <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #dc3545;">
                <strong>‚ö†Ô∏è Declive Reciente:</strong> Actividad de la √∫ltima semana <20% de la actividad hist√≥rica.
                <br><strong>Acci√≥n:</strong> Investigar qu√© cambi√≥ (ex√°menes terminaron, contenido se agot√≥, problema t√©cnico).
            </div>

            <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #10b981;">
                <strong>üöÄ Pico Inusual:</strong> Actividad reciente >5x la actividad hist√≥rica (puede ser positivo o negativo).
                <br><strong>Acci√≥n:</strong> Identificar causa (deadline cercano, nuevo contenido popular, campa√±a de marketing).
            </div>

            <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #6b7280;">
                <strong>üîç Patr√≥n At√≠pico:</strong> Combinaci√≥n inusual de m√©tricas que no encaja en categor√≠as anteriores.
                <br><strong>Acci√≥n:</strong> An√°lisis manual detallado para entender la causa ra√≠z.
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 30px; background: #fef3c7;">
        <h3 style="color: #78350f;">üí° ¬øC√≥mo funciona Isolation Forest?</h3>
        <div style="color: #78350f; line-height: 1.8;">
            <p>
                <strong>Isolation Forest</strong> es un algoritmo de Machine Learning dise√±ado espec√≠ficamente para detectar outliers (valores at√≠picos).
                Funciona "aislando" puntos de datos an√≥malos, que son m√°s f√°ciles de separar del resto.
            </p>

            <p><strong>¬øPor qu√© es √∫til?</strong></p>
            <ul>
                <li><strong>No requiere etiquetas:</strong> Aprende autom√°ticamente qu√© es "normal" sin necesitar ejemplos previos de anomal√≠as</li>
                <li><strong>Detecta patrones complejos:</strong> Identifica anomal√≠as multidimensionales que ser√≠an invisibles mirando una m√©trica a la vez</li>
                <li><strong>Escalable:</strong> Funciona eficientemente con grandes vol√∫menes de datos</li>
            </ul>

            <p><strong>Tasa de Contaminaci√≥n ({{ contamination_rate }}%):</strong></p>
            <p style="margin-left: 20px;">
                Par√°metro que controla cu√°ntos cursos se consideran an√≥malos. Un 10% significa que esperamos que ~1 de cada 10 cursos
                tenga comportamiento inusual. Ajustable seg√∫n las caracter√≠sticas de tu instituci√≥n.
            </p>
        </div>
    </div>
    {% else %}
    <div class="alert">
        <p>No se detectaron anomal√≠as en los {{ total_courses_analyzed }} cursos analizados, o no hay suficientes datos (m√≠nimo 10 cursos).</p>
    </div>
    {% endif %}

    <div style="margin-top: 30px;">
        <a href="{% url 'analytics_menu' %}" class="button">‚Üê Volver al men√∫ de estad√≠sticas</a>
    </div>
</div>
{% endblock %}
